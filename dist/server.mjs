import Is from'ip';import f from'picocolors';import Ts from'cookie-parser';import ws from'cors';import gt from'dotenv';import rr,{urlencoded}from'express';import xs from'helmet';import $e from'passport';import {Strategy}from'passport-google-oauth20';import Me from'bcrypt';import {relations,and,eq,ilike,inArray,gte,lte,count,desc,asc,or}from'drizzle-orm';import {StatusCodes}from'http-status-codes';import {drizzle}from'drizzle-orm/node-postgres';import St from'pg';import {timestamp,text,pgEnum,pgTable,serial,integer,unique,varchar,boolean,json}from'drizzle-orm/pg-core';import {Strategy as Strategy$1}from'passport-local';import {z as z$1,ZodError}from'zod';import kt from'nodemailer';import u from'handlebars';import {json2csv}from'json-2-csv';import {doubleCsrf}from'csrf-csrf';import ys from'express-rate-limit';import Rs,{Store}from'express-session';import {readFileSync}from'fs';import {join}from'path';var Jr=Object.defineProperty;var ge=(t,e)=>{for(var r in e)Jr(t,r,{get:e[r],enumerable:true});};var Ae={};ge(Ae,{ROLE_TYPE:()=>ir,TOKEN_TYPE:()=>nr,accounts:()=>M,accountsRelations:()=>Zr,sessions:()=>O,sessionsRelations:()=>rt,users:()=>p,usersRelations:()=>et,verificationToken:()=>P});var D={createdAt:timestamp("created_at",{withTimezone:true}).notNull().defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).notNull().defaultNow().$onUpdate(()=>new Date)};({metaTitle:text("meta_title").notNull().default("SEO Title"),metaDescription:text("meta_description").notNull().default("SEO Description"),metaKeywords:text("meta_keywords").notNull().default("SEO Keywords")});var ye={enumValues:["ADMIN","SUPERVISOR","MEMBER"]},b={PASSWORD_RESET:"PASSWORD_RESET",EMAIL_VERIFICATION:"EMAIL_VERIFICATION",LOGIN_OTP:"LOGIN_OTP",enumValues:["PASSWORD_RESET","EMAIL_VERIFICATION","LOGIN_OTP"]};var ir=pgEnum("role_type",ye.enumValues),nr=pgEnum("token_type",b.enumValues),p=pgTable("users",{id:serial("id").primaryKey(),name:text("name"),username:text("username").unique(),email:text("email").unique(),password:text("password"),emailVerified:timestamp("email_verified",{withTimezone:true}),image:text("image"),role:ir("role").notNull().default("MEMBER"),...D}),M=pgTable("accounts",{id:serial("id").primaryKey(),userId:integer("user_id").notNull().references(()=>p.id,{onDelete:"cascade"}),type:text("type").notNull(),provider:text("provider").notNull(),providerAccountId:text("provider_account_id").notNull(),refreshToken:text("refresh_token"),accessToken:text("access_token"),expiresAt:integer("expires_at"),tokenType:text("token_type"),scope:text("scope"),idToken:text("id_token"),sessionState:text("session_state"),...D}),O=pgTable("sessions",{id:serial("id").primaryKey(),sessionId:text("session_id").notNull().unique(),sessionCookie:text("session_cookie").unique(),userId:integer("user_id").references(()=>p.id,{onDelete:"cascade"}),expires:timestamp("expires",{withTimezone:true}).notNull(),...D}),P=pgTable("verification_token",{id:serial("id").primaryKey(),identifier:text("identifier").notNull(),token:text("token").notNull(),tokenType:nr("token_type").notNull(),expires:timestamp("expires",{withTimezone:true}).notNull(),...D},t=>[unique("verification_token_unique").on(t.identifier,t.tokenType)]),Zr=relations(M,({one:t})=>({user:t(p,{fields:[M.userId],references:[p.id]})})),et=relations(p,({many:t})=>({accounts:t(M),sessions:t(O)})),rt=relations(O,({one:t})=>({user:t(p,{fields:[O.userId],references:[p.id]})}));var De={};ge(De,{email:()=>E});var E=pgTable("email",{id:serial("id").primaryKey(),emailConfigName:varchar("email_config_name",{length:255}).notNull().unique(),host:varchar("host",{length:255}).notNull(),port:integer("port").notNull(),username:varchar("username",{length:255}).notNull(),password:varchar("password",{length:255}).notNull(),secure:boolean("secure").notNull().default(false),fromName:varchar("from_name",{length:255}).notNull(),fromEmail:varchar("from_email",{length:255}).notNull(),...D});var Ie={};ge(Ie,{emailTemplates:()=>Ce});var Ce=pgTable("email_templates",{id:serial("id").primaryKey(),name:varchar("name",{length:255}).unique().notNull(),subject:text("subject").notNull(),html:text("html").notNull(),...D});var _e={};ge(_e,{media:()=>ft});var ft=pgTable("media",{id:serial("id").primaryKey(),src:text("src").notNull().unique(),alt:text("alt").notNull(),size:integer("file_size").notNull(),mimeType:varchar("mime_type",{length:100}).notNull(),additionalData:json("additional_data"),...D});var ht={...Ae,...De,...Ie,..._e},pr=ht;gt.config();var Rt=new St.Pool({connectionString:process.env.DATABASE_URL}),vt=drizzle(Rt,{schema:pr}),q=vt;var x=class{db;currentTx=null;constructor(){this.db=q;}setTransaction(e){return this.currentTx=e,this}clearTransaction(){return this.currentTx=null,this}getDb(){return this.currentTx||this.db}};var ke=class{clientDomain=null;serverDomain=null;setClientDomain(e){this.clientDomain=e;}getClientDomain(){return this.clientDomain}setServerDomain(e){this.serverDomain=e;}getServerDomain(){return this.serverDomain}},Et=new ke,Z=Et;var R=class{static detectInputType(e){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?"EMAIL":"USERNAME"}static OTPGenerator(e=4){if(e<4)throw new Error("The OTP length must be at least 4.");let r=Math.pow(10,e-1),s=Math.pow(10,e)-1;return Math.floor(Math.random()*(s-r+1)+r)}static OTPExpiry(e=5){let r=new Date;return new Date(r.getTime()+e*6e4)}static sameSiteCookieConfig(){try{let e=A=>/^(\d{1,3}\.){3}\d{1,3}$/.test(A);if(process.env.COOKIE_SETTINGS==="locally")return {sameSite:"lax",secure:!1};if(process.env.COOKIE_SETTINGS==="globally"&&process.env.COOKIE_DOMAIN){let A=process.env.COOKIE_DOMAIN,B=A.startsWith(".")?A.substring(1):A;return e(B)?{sameSite:process.env.COOKIE_SAME_SITE,secure:!0,domain:A}:{sameSite:process.env.COOKIE_SAME_SITE,secure:!0,domain:A}}let r=Z.getClientDomain(),s=Z.getServerDomain()||process.env.API_URL;if(!r)return {sameSite:"none",secure:!0};let o=new URL(r),n=new URL(s),a=n.protocol==="https:",h=A=>A.split(":")[0],d=A=>{let B=h(A);if(B==="localhost"||e(B))return B;let tr=B.split(".");return tr.length<2?B:tr.slice(-2).join(".")},S=d(o.hostname),ne=d(n.hostname),H,ae;return h(o.hostname)===h(n.hostname)?(H=h(n.hostname),ae="lax"):S===ne&&!e(S)&&S!=="localhost"?(H="."+S,ae="lax"):(H=h(n.hostname),ae="none"),ae==="none"&&(a=!0),{sameSite:ae,secure:a,domain:H}}catch{return {sameSite:"lax",secure:true}}}};var Tt=t=>t!==null&&typeof t=="object"&&"status"in t&&typeof t.status=="number"&&"message"in t&&typeof t.message=="string",mr=new Set([StatusCodes.NO_CONTENT]),i=class{static async createResponse(e,r,s,o){return mr.has(e)?Promise.resolve({status:e,message:r,data:void 0}):Promise.resolve({status:e,message:r,data:s,pagination:o})}static async createRejectResponse(e,r){return Promise.reject({status:e,message:r})}static createErrorResponse(e){return console.error("Error:",e instanceof Error?e.message:e),Tt(e)?Promise.reject(e):Promise.reject({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Internal Server Error"})}},C=class{response;constructor(e){this.response=e;}successResponse(e,r,s){return this.sendResponse({status:StatusCodes.OK,message:e,data:r,pagination:s})}unauthorizedResponse(e){return this.sendResponse({status:StatusCodes.UNAUTHORIZED,message:e})}forbiddenResponse(e){return this.sendResponse({status:StatusCodes.FORBIDDEN,message:e})}badResponse(e){return this.sendResponse({status:StatusCodes.BAD_REQUEST,message:e})}internalServerError(e="Internal Server Error"){return this.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:e})}sendResponse({status:e,message:r,data:s,pagination:o}){if(mr.has(e))return this.response.status(e).json({});let n={status:e,message:r};return s!==void 0&&(n.data=s),o&&(n.pagination=o),this.response.status(e).json(n)}};var _=class extends x{async createUser(e){try{e.username&&await this.duplicateUserCheckByUsername(e.username),e.email&&await this.duplicateUserCheckByEmail(e.email),e.password&&(e.password=await Me.hash(e.password,10));let r=await this.getDb().insert(p).values(e).returning(),{password:s,...o}=r[0];return i.createResponse(StatusCodes.CREATED,"User created successfully",o)}catch(r){return i.createErrorResponse(r)}}async createGoogleAccount(e,r,s){try{let o=await this.getDb().insert(M).values({userId:e,type:"oauth",provider:"google",providerAccountId:r.id,accessToken:s,refreshToken:null,expiresAt:6048e5,tokenType:"access_token",scope:"profile",idToken:r.id,sessionState:null}).returning();return i.createResponse(StatusCodes.CREATED,"Google account created successfully",o[0])}catch(o){return i.createErrorResponse(o)}}async createUserFromGoogle(e,r){try{let s=await this.getDb().query.users.findFirst({where:eq(p.email,e._json.email),with:{accounts:{where:and(eq(M.providerAccountId,e.id),eq(M.provider,"google"))}}});if(s)if(s.accounts.length>0){await this.getDb().update(M).set({accessToken:r}).where(eq(M.providerAccountId,e.id)),s.emailVerified||await this.accountVerification(s.id);let{accounts:n,...a}=s;return i.createResponse(StatusCodes.OK,"Google account updated successfully",a)}else {await this.createGoogleAccount(s.id,e,r);let{accounts:n,...a}=s;return i.createResponse(StatusCodes.CREATED,"Google account created successfully",a)}let o=await this.createUser({name:e._json.name,email:e._json.email,username:e._json.email.split("@")[0],password:null,emailVerified:new Date,image:e._json.picture,role:"MEMBER"});return await this.createGoogleAccount(o.data?.id,e,r),i.createResponse(StatusCodes.CREATED,"User created successfully",o.data)}catch(s){return i.createErrorResponse(s)}}async findUserByUsernameOrEmail(e){try{let r=R.detectInputType(e),s={};return r==="EMAIL"?(s=(await this.findUserByEmail(e,!0)).data,i.createResponse(StatusCodes.OK,"User found successfully",s)):r==="USERNAME"?(s=(await this.findUserByUsername(e,!0)).data,i.createResponse(StatusCodes.OK,"User found successfully",s)):i.createResponse(StatusCodes.BAD_REQUEST,"Invalid input type",s)}catch(r){return i.createErrorResponse(r)}}async findUserById(e,r=false){try{let s=await this.getDb().query.users.findFirst({where:eq(p.id,e)});if(!s)return i.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(r)return i.createResponse(StatusCodes.OK,"User found successfully",s);let{password:o,...n}=s;return i.createResponse(StatusCodes.OK,"User found successfully",n)}catch(s){return i.createErrorResponse(s)}}async findUserByEmail(e,r=false){try{let s=await this.getDb().query.users.findFirst({where:eq(p.email,e)});if(!s)return i.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(r)return i.createResponse(StatusCodes.OK,"User found successfully",s);let{password:o,...n}=s;return i.createResponse(StatusCodes.OK,"User found successfully",n)}catch(s){return i.createErrorResponse(s)}}async findUserByUsername(e,r=false){try{let s=await this.getDb().query.users.findFirst({where:eq(p.username,e)});if(!s)return i.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(r)return i.createResponse(StatusCodes.OK,"User found successfully",s);let{password:o,...n}=s;return i.createResponse(StatusCodes.OK,"User found successfully",n)}catch(s){return i.createErrorResponse(s)}}async duplicateUserCheckByEmail(e){try{return await this.getDb().query.users.findFirst({where:eq(p.email,e)})?i.createRejectResponse(StatusCodes.CONFLICT,"User already exists"):i.createResponse(StatusCodes.OK,"User does not exist",!1)}catch(r){return i.createErrorResponse(r)}}async duplicateUserCheckByUsername(e){try{return await this.getDb().query.users.findFirst({where:eq(p.username,e)})?i.createRejectResponse(StatusCodes.CONFLICT,"User already exists"):i.createResponse(StatusCodes.OK,"User does not exist",!1)}catch(r){return i.createErrorResponse(r)}}async changePassword(e,r){try{let s=await Me.hash(r,10);return await this.getDb().update(p).set({password:s}).where(eq(p.id,e)),i.createResponse(StatusCodes.OK,"Password changed successfully",!0)}catch(s){return i.createErrorResponse(s)}}async passwordChecker(e,r){try{if(!r)return i.createRejectResponse(StatusCodes.NOT_FOUND,"User account has no password");let s=await Me.compare(e,r);return s?i.createResponse(StatusCodes.OK,"Password checked",s):i.createRejectResponse(StatusCodes.BAD_REQUEST,"Password incorrect")}catch(s){return i.createErrorResponse(s)}}async accountVerification(e){try{return await this.getDb().update(p).set({emailVerified:new Date}).where(eq(p.id,e)),i.createResponse(StatusCodes.OK,"User verified",!0)}catch(r){return i.createErrorResponse(r)}}async checkAccountVerification(e){try{return (await this.findUserById(e)).data?.emailVerified?i.createResponse(StatusCodes.OK,"User is verified",!0):i.createRejectResponse(StatusCodes.NOT_FOUND,"User is not verified")}catch(r){return i.createErrorResponse(r)}}};var lr=new _;$e.serializeUser(async(t,e)=>{try{e(null,t.id);}catch(r){e(r,false);}});$e.deserializeUser(async(t,e)=>{try{let r=await lr.findUserById(t);e(null,r.data);}catch(r){e(r,false);}});$e.use(new Strategy({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:process.env.GOOGLE_CALLBACK_URL},async(t,e,r,s)=>{try{let o=await lr.createUserFromGoogle(r,t);s(null,o.data);}catch(o){console.error("Google strategy error:",o),s(o,false);}}));var ve=new _;$e.serializeUser((t,e)=>{e(null,t.id);});$e.deserializeUser(async(t,e)=>{try{let r=await ve.findUserById(t,!1);r.data?e(null,r.data):e(new Error("User not found"),null);}catch(r){e(r,null);}});$e.use(new Strategy$1({usernameField:"usernameOrEmail",passwordField:"password"},async(t,e,r)=>{try{let s=await ve.findUserByUsernameOrEmail(t);if(!s.data)return r(null,!1,{message:"Invalid credentials"});if(!(await ve.passwordChecker(e,s.data.password)).data)return r(null,!1,{message:"Invalid credentials"});let n=await ve.findUserById(s.data.id,!1);return r(null,n.data)}catch(s){return r(s)}}));function Fe(t){t.get("/",(e,r)=>{r.status(200).send(`
				<!DOCTYPE html>
				<html lang="en">
				<head>
						<meta charset="UTF-8">
						<meta name="viewport" content="width=device-width, initial-scale=1.0">
						<title>Welcome Page</title>
						<style>
								body {
										font-family: Arial, sans-serif;
										background-color: #f4f4f9;
										color: #333;
										margin: 0;
										padding: 0;
										display: flex;
										justify-content: center;
										align-items: center;
										height: 100vh;
								}
								.container {
										text-align: center;
										background: white;
										padding: 20px;
										border-radius: 10px;
										box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
								}
								h1 {
										color: #4CAF50;
								}
								p {
										font-size: 1.2em;
								}
						</style>
				</head>
				<body>
						<div class="container">
								<h1>Welcome to the Application</h1>
								<p>All the API routes start with <code>/api</code></p>
								<p>For example: <code>/api/auth/login</code></p>
						</div>
				</body>
				</html>
    `);});}var l={error:{required:{fieldIsRequired:t=>`${t} is required.`},limit:{stringMin:(t,e)=>`${t} must be at least ${e} characters.`,stringMax:(t,e)=>`${t} must not exceed ${e} characters.`,arrayMin:(t,e)=>`${t} must have at least ${e} items.`,arrayMax:(t,e)=>`${t} must not exceed ${e} items.`,numberMin:(t,e)=>`${t} must be at least ${e}.`,numberMax:(t,e)=>`${t} must not exceed ${e}.`,fileSize:(t,e)=>`${t} must not exceed ${e}.`,length:(t,e)=>`${t} must be exactly ${e} characters.`},invalid:{invalidString:t=>`${t} must be a string.`,invalidEmail:t=>`${t} must be a valid email address.`,invalidNumber:t=>`${t} must be a number.`,invalidBoolean:t=>`${t} must be a boolean.`,invalidDate:t=>`${t} must be a date.`,invalidArray:t=>`${t} must be an array.`,invalidObject:t=>`${t} must be an object.`,invalidEnum:(t,e)=>`${t} must be one of the following values: ${e.join(", ")}.`,invalidUnion:t=>`${t} must be one of the specified types.`,invalidIntersection:t=>`${t} must be a combination of the specified types.`,invalidTuple:t=>`${t} must be a tuple.`,invalidRecord:t=>`${t} must be a record.`,invalidLiteral:(t,e)=>`${t} must be the literal value: ${e}.`,invalidNull:t=>`${t} must be null.`,invalidUndefined:t=>`${t} must be undefined.`,invalidOptional:t=>`${t} must be optional.`,invalidNullable:t=>`${t} must be nullable.`,invalidPromise:t=>`${t} must be a promise.`,invalidFunction:t=>`${t} must be a function.`,invalidClass:t=>`${t} must be a class.`,invalidUnknown:t=>`${t} must be unknown.`,invalidNever:t=>`${t} must be never.`,invalidVoid:t=>`${t} must be void.`,invalidAny:t=>`${t} must be any.`,invalidUnknownKeys:t=>`${t} must have unknown keys.`,invalidFile:t=>`${t} must be a file.`,invalidFileSize:(t,e)=>`${t} must not exceed ${e} bytes.`,invalidFileType:(t,e)=>`${t} must be of type ${e}.`,invalidUpperCase:t=>`${t} must be at least one upper case.`,invalidLowerCase:t=>`${t} must be at least one lower case.`,invalidNumericCase:t=>`${t} must be at least one number.`,invalidPhoneNumber:t=>`${t} must be a valid phone number.`,invalidUsername:t=>`${t} must contain only letters, numbers, and underscores.`,invalidUsernameOrEmail:t=>`${t} must be a valid username or email address.`}}};var T=(t,e,r)=>{switch(e){case "required":return l.error.required.fieldIsRequired(t);case "invalid":return r||l.error.invalid.invalidString(t);case "limit":return r;default:return `${t} is invalid`}},$=(t,e)=>{let r=z$1.string({error:s=>s.input===void 0?T(t,"required"):T(t,"invalid")});return e?.min&&(r=r.min(e.min,{error:T(t,"limit",l.error.limit.stringMin(t,e.min))})),e?.max&&(r=r.max(e.max,{error:T(t,"limit",l.error.limit.stringMax(t,e.max))})),e?.regex&&(r=r.regex(e.regex,{error:e.regexMsg||T(t,"invalid")})),r},ur=(t,e)=>{let r=z$1.coerce.number({error:s=>s.input===void 0?T(t,"required"):l.error.invalid.invalidNumber(t)});return e?.min&&(r=r.min(e.min,{error:T(t,"limit",l.error.limit.numberMin(t,e.min))})),e?.positive&&(r=r.positive({error:T(t,"invalid")})),e?.int&&(r=r.int({error:T(t,"invalid")})),r},xt=t=>z$1.boolean({error:()=>T(t,"required")}),Pt=(t,e)=>z$1.enum(e,{error:()=>l.error.invalid.invalidEnum(t,e)});var dr=(t,e,r)=>{let s=z$1.array(e,{error:()=>l.error.invalid.invalidArray?l.error.invalid.invalidArray(t):`${t} must be an array`});return r?.min&&(s=s.min(r.min,{error:T(t,"limit",l.error.limit.arrayMin?l.error.limit.arrayMin(t,r.min):`${t} must have at least ${r.min} items`)})),r?.max&&(s=s.max(r.max,{error:T(t,"limit",l.error.limit.arrayMax?l.error.limit.arrayMax(t,r.max):`${t} must have at most ${r.max} items`)})),s},fr=(t,e)=>z$1.union(e,{error:()=>l.error.invalid.invalidUnion?l.error.invalid.invalidUnion(t):`${t} must match one of the allowed types`}),c=$,hr=ur,k=t=>ur(t,{min:1,positive:true,int:true}),G=xt,re=Pt;var gr=dr,yr=fr;var Ee=t=>fr(t,[N,dr(t,N)]),Te=(t,e)=>{let r=$(t,{min:1}).refine(s=>!isNaN(Number(s)),{error:l.error.invalid.invalidNumber(t)}).transform(s=>Number(s));return e?.min&&(r=r.refine(s=>s>=e.min,{error:T(t,"limit",l.error.limit.numberMin?l.error.limit.numberMin(t,e.min):`${t} must be at least ${e.min}`)})),e?.max&&(r=r.refine(s=>s<=e.max,{error:T(t,"limit",l.error.limit.numberMax?l.error.limit.numberMax(t,e.max):`${t} must be at most ${e.max}`)})),e?.int&&(r=r.refine(s=>Number.isInteger(s),{error:T(t,"invalid",`${t} must be an integer`)})),r};var we=$("Username",{min:1,max:20,regex:/^[a-zA-Z0-9_]*$/,regexMsg:l.error.invalid.invalidUsername("Username")}),N=$("Email",{min:1}).email({error:l.error.invalid.invalidEmail("Email")});var je=$("Username or email",{min:1,max:255}).refine(t=>{let e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,r=/^[a-zA-Z0-9_]*$/;return t.includes("@")?e.test(t):r.test(t)&&t.length<=20},{error:l.error.invalid.invalidUsernameOrEmail("Username or email")}),Nt=[{regex:/[A-Z]/,msg:t=>l.error.invalid.invalidUpperCase(t)},{regex:/[a-z]/,msg:t=>l.error.invalid.invalidLowerCase(t)},{regex:/\d/,msg:t=>l.error.invalid.invalidNumericCase(t)}],He=t=>$(t,{min:6}).superRefine((e,r)=>{Nt.forEach(s=>{s.regex.test(e)||r.addIssue({code:"custom",message:s.msg(t)});});}),ce=He("Password"),ze=He("New Password");He("Confirm Password");z$1.object({metaTitle:$("Meta Title",{max:255}).optional(),metaDescription:$("Meta Description",{max:500}).optional(),metaKeywords:$("Meta Keywords").optional(),metaThumbnailId:k("Meta Thumbnail ID").optional()});var Sr=z$1.object({usernameOrEmail:je,password:c("Password")}),Rr=z$1.object({usernameOrEmail:je,password:c("Password"),otp:k("OTP")}),vr=z$1.object({username:we,email:N,password:ze,name:c("Name")}),Be=z$1.object({email:N}),qe=z$1.object({email:N,otp:k("OTP")}),Er=z$1.object({email:N,otp:k("OTP"),password:ce});z$1.object({oldPassword:ce,newPassword:ze});z$1.object({organizationId:k("Organization ID").or(z$1.null({error:t=>t.input!==null?"Organization ID must be a positive number or null":void 0}))});var W=class{page;limit;totalItems;constructor(e,r,s){this.page=e,this.limit=r,this.totalItems=s;}createPagination(){let e=Math.ceil(this.totalItems/this.limit),r=this.page;this.page>e&&e>0&&(r=e);let s=(r-1)*this.limit;return {pagination:{totalItems:this.totalItems,limit:this.limit,offset:s,currentPage:r,totalPages:e,hasPrevPage:r>1,hasNextPage:r<e,prevPage:r>1?r-1:null,nextPage:r<e?r+1:null},offset:s}}};var z=class{model;sortableFields;constructor(e){this.model=e,this.sortableFields=this.getDynamicSortFields();}getDynamicSortFields(){let e={};for(let[r,s]of Object.entries(this.model))typeof s=="object"&&"name"in s&&(e[r]=s);return e}getValidSortFields(){return Object.keys(this.sortableFields)}applySorting(e,r){if(!e)return desc(this.model.id);let s=this.sortableFields[e];return s?(r?.toLowerCase()==="asc"?asc:desc)(s):desc(this.model.id)}isValidSortMethod(e){return e in this.sortableFields}isValidSortDirection(e){return ["asc","desc"].includes(e.toLowerCase())}};var me=class extends x{sortingHelper;constructor(){super(),this.sortingHelper=new z(E);}async retrieve(e){try{let r=this.sortingHelper.applySorting(e.sortingMethod,e.sortBy);if(!e.page||!e.limit)return await this.retrieveAll(e.sortingMethod,e.sortBy);let s=e.from?new Date(e.from):void 0,o=e.to?new Date(e.to):void 0;o&&o.setHours(23,59,59,999);let n=[e.search?or(ilike(E.username,`%${e.search}%`),ilike(E.emailConfigName,`%${e.search}%`),ilike(E.fromName,`%${e.search}%`),ilike(E.fromEmail,`%${e.search}%`),ilike(E.host,`%${e.search}%`)):void 0,s?gte(E.createdAt,s):void 0,o?lte(E.createdAt,o):void 0].filter(Boolean),a=n.length>0?and(...n):void 0,h=await this.db.select({count:count()}).from(E).where(a).then(H=>H[0].count),{pagination:d,offset:S}=new W(e.page,e.limit,h).createPagination(),ne=await this.db.query.email.findMany({where:a,limit:e.limit?e.limit:void 0,offset:e.limit?S:void 0,orderBy:r});return i.createResponse(StatusCodes.OK,"Email retrieved successfully",ne,d)}catch(r){return i.createErrorResponse(r)}}async retrieveAll(e,r){try{let s=this.sortingHelper.applySorting(e,r),o=await this.db.query.email.findMany({orderBy:s});return i.createResponse(StatusCodes.OK,"Email retrieved successfully",o)}catch(s){return i.createErrorResponse(s)}}async retrieveOne(e){try{let r=await this.db.query.email.findFirst({where:eq(E.id,e)});return r?i.createResponse(StatusCodes.OK,"Email retrieved successfully",r):i.createRejectResponse(StatusCodes.NOT_FOUND,"Email not found")}catch(r){return i.createErrorResponse(r)}}async retrieveOneByConfigName(e){try{let r=await this.db.query.email.findFirst({where:eq(E.emailConfigName,e)});return r?i.createResponse(StatusCodes.OK,"Email retrieved successfully",r):i.createResponse(StatusCodes.NOT_FOUND,"Email not found",null)}catch(r){return i.createErrorResponse(r)}}async update(e,r){try{let s=await this.db.update(E).set(r).where(eq(E.id,e)).returning().then(o=>o[0]);return s?i.createResponse(StatusCodes.OK,"Email updated successfully",s):i.createRejectResponse(StatusCodes.NOT_FOUND,"Email not found")}catch(s){return i.createErrorResponse(s)}}async validateSmtpConnection(e){try{let r=Number(e.port),s=e.secure,o=!1;return r===465?s=!0:(r===587||r===25)&&(s=!1,o=!0),await kt.createTransport({host:e.host,port:r,secure:s,requireTLS:o,auth:{user:e.username,pass:e.password},tls:{rejectUnauthorized:!1,minVersion:"TLSv1",ciphers:"SSLv3"},connectionTimeout:1e4,greetingTimeout:1e4,socketTimeout:1e4}).verify(),i.createResponse(StatusCodes.OK,"SMTP connection validated successfully",!0)}catch(r){return i.createErrorResponse(r)}}};var le=class extends x{async retrieveEmailTemplate(e){try{let r=await this.getDb().query.emailTemplates.findFirst({where:eq(Ce.name,e)});return r?i.createResponse(StatusCodes.OK,"Email template retrieved successfully",r):i.createResponse(StatusCodes.NOT_FOUND,"Email template not found",null)}catch(r){return i.createErrorResponse(r)}}};var te=class{request;response;apiResponse;constructor(e,r){this.request=e,this.response=r,this.apiResponse=new C(r);}};var $t=z$1.record(z$1.string(),z$1.any()),wr=z$1.object({host:c("Host",{min:1}),port:hr("Port",{min:1}).max(65535,{message:"Port must be between 1 and 65535"}),secure:G("Secure"),auth:z$1.object({user:N,pass:c("Password",{min:1})}),service:c("Service").optional(),tls:z$1.object({rejectUnauthorized:G("Reject Unauthorized").optional()}).optional()}),br=z$1.object({to:Ee("To"),subject:c("Subject",{min:1}),text:c("Text").optional(),html:c("HTML").optional(),templateHtml:c("Template HTML").optional(),templateData:$t.optional(),name:c("Name").optional(),from:N.optional(),cc:Ee("CC").optional(),bcc:Ee("BCC").optional(),attachments:gr("Attachments",z$1.object({filename:c("Filename",{min:1}),path:c("Path").optional(),content:yr("Content",[c("Content"),z$1.instanceof(Buffer)]).optional(),contentType:c("Content Type").optional()})).optional()}).refine(t=>t.text||t.html||t.templateHtml,{message:"Either text, html, or templateHtml must be provided",path:["html"]});var be=class{transporter;defaultFrom;templateCache=new Map;helpersRegistered=false;constructor(e){let r=wr.parse(e);this.transporter=kt.createTransport({host:r.host,port:r.port,secure:r.secure,auth:r.auth,...r.service&&{service:r.service},...r.tls&&{tls:r.tls}}),this.defaultFrom=r.auth.user,this.initializeHandlebars();}initializeHandlebars(){this.helpersRegistered||(u.registerHelper("formatDate",(e,r)=>{try{let s=new Date(e);if(isNaN(s.getTime()))return e;switch(r){case "short":return s.toLocaleDateString();case "long":return s.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});case "time":return s.toLocaleTimeString();case "datetime":return s.toLocaleString();default:return s.toLocaleDateString()}}catch{return e}}),u.registerHelper("formatCurrency",(e,r="USD")=>{try{return new Intl.NumberFormat("en-US",{style:"currency",currency:r}).format(e)}catch{return e}}),u.registerHelper("formatNumber",(e,r)=>{try{return new Intl.NumberFormat("en-US",{minimumFractionDigits:r,maximumFractionDigits:r}).format(e)}catch{return e}}),u.registerHelper("ifEquals",function(e,r,s){return e==r?s.fn(this):s.inverse(this)}),u.registerHelper("ifNotEquals",function(e,r,s){return e!=r?s.fn(this):s.inverse(this)}),u.registerHelper("ifGreater",function(e,r,s){return e>r?s.fn(this):s.inverse(this)}),u.registerHelper("ifLess",function(e,r,s){return e<r?s.fn(this):s.inverse(this)}),u.registerHelper("length",e=>Array.isArray(e)?e.length:0),u.registerHelper("isEmpty",e=>!Array.isArray(e)||e.length===0),u.registerHelper("isNotEmpty",e=>Array.isArray(e)&&e.length>0),u.registerHelper("add",(e,r)=>e+r),u.registerHelper("subtract",(e,r)=>e-r),u.registerHelper("multiply",(e,r)=>e*r),u.registerHelper("divide",(e,r)=>r!==0?e/r:0),u.registerHelper("modulo",(e,r)=>r!==0?e%r:0),u.registerHelper("uppercase",e=>e?.toUpperCase()||""),u.registerHelper("lowercase",e=>e?.toLowerCase()||""),u.registerHelper("capitalize",e=>e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():""),u.registerHelper("truncate",(e,r)=>!e||e.length<=r?e:e.substring(0,r)+"..."),u.registerHelper("json",e=>JSON.stringify(e)),u.registerHelper("currentYear",()=>new Date().getFullYear()),u.registerHelper("currentDate",()=>new Date().toLocaleDateString()),u.registerHelper("times",function(e,r){let s="";for(let o=0;o<e;o++)s+=r.fn({index:o,number:o+1});return s}),this.helpersRegistered=true);}compileTemplate(e,r){if(r&&this.templateCache.has(r))return this.templateCache.get(r);try{let s=u.compile(e);return r&&this.templateCache.set(r,s),s}catch(s){throw new Error(`Failed to compile template: ${s instanceof Error?s.message:"Unknown error"}`)}}renderTemplate(e,r={},s){try{return this.compileTemplate(e,s)(r)}catch(o){throw new Error(`Failed to render template: ${o instanceof Error?o.message:"Unknown error"}`)}}registerHelper(e,r){u.registerHelper(e,r);}registerHelpers(e){Object.entries(e).forEach(([r,s])=>{this.registerHelper(r,s);});}clearTemplateCache(){this.templateCache.clear();}async verifyConnection(){try{return await this.transporter.verify(),!0}catch(e){return console.error("Email connection failed:",e),false}}async sendEmail(e){try{let r=br.parse(e),s=r.html;if(r.templateHtml){let h=r.templateData?`template_${Buffer.from(r.templateHtml).toString("base64").substring(0,32)}`:void 0;s=this.renderTemplate(r.templateHtml,r.templateData||{},h);}let n={from:r.name?`${r.name} <${r.from||this.defaultFrom}>`:this.defaultFrom,to:r.to,subject:r.subject,text:r.text,html:s,cc:r.cc,bcc:r.bcc,attachments:r.attachments};return {success:!0,messageId:(await this.transporter.sendMail(n)).messageId}}catch(r){let s=r instanceof Error?r.message:"Unknown error occurred";return console.error("Failed to send email:",s),{success:false,error:s}}}async sendBulkEmails(e){return Promise.all(e.map(r=>this.sendEmail(r)))}close(){this.transporter.close();}};function Ge(){let t={host:process.env.SMTP_HOST,port:process.env.SMTP_PORT,secure:process.env.SMTP_PORT===465,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASSWORD}};return new be(t)}async function We(t){try{let e=await t.emailTemplateService.retrieveEmailTemplate(t.templateName);if(!e?.data)throw new Error(`Email template '${t.templateName}' not found or has no data`);let r=await t.emailService.retrieveOneByConfigName(t.emailConfigName);if(!r?.data)throw new Error(`Email service configuration '${t.emailConfigName}' not found or has no data`);let o=await Ge().sendEmail({to:t.to,subject:t.subject||e.data.subject,templateHtml:e.data.html,templateData:t.templateData,from:r.data.fromEmail,name:r.data.fromName});if(!o.success)throw new Error(o.error||"Failed to send email")}catch(e){let r=e instanceof Error?e.message:String(e);throw new Error(`Failed to send email with template '${t.templateName}' to '${t.to}': ${r}`)}}var de=class extends x{async limitOTPRequest(e,r,s){try{let o=await this.getDb().query.verificationToken.findFirst({where:and(eq(P.identifier,e.email),eq(P.tokenType,r))}),n=new Date().getTime(),a=new Date(o?.updatedAt).getTime(),h=n-a,d=Math.floor(h/6e4);if(o&&d<s){let S=`You can only request OTP per ${s} minute(s). Please wait for ${s-d} minute(s)`;return i.createRejectResponse(StatusCodes.TOO_MANY_REQUESTS,S)}return Promise.resolve(!0)}catch(o){return i.createErrorResponse(o)}}async saveOTPToDatabase(e,r,s=Number(process.env.OTP_RESET_EXPIRY)){try{if(!e.email)return i.createRejectResponse(StatusCodes.NOT_FOUND,"Email is not registered");let o=new Date,n=new Date(o.getTime()+s*6e4);await this.limitOTPRequest(e,r,s);let a=R.OTPGenerator(6),h=Me.hashSync(String(a),10);return await this.getDb().insert(P).values({identifier:e.email,token:h,tokenType:r,expires:n}).onConflictDoUpdate({target:[P.identifier,P.tokenType],set:{token:h,expires:n}}),Promise.resolve(a)}catch(o){return i.createErrorResponse(o)}}async verifyOTPFromDatabase(e,r,s){try{let o=await this.getDb().query.verificationToken.findFirst({where:and(eq(P.identifier,e.email),eq(P.tokenType,s))});return o&&o.token&&!Me.compareSync(r,o.token)?i.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid OTP"):o?o?.expires&&o.expires<new Date?(await this.deleteOTPFromDatabase(e,s),i.createRejectResponse(StatusCodes.REQUEST_TIMEOUT,"OTP expired")):Promise.resolve(!0):i.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid OTP")}catch(o){return i.createErrorResponse(o)}}async deleteOTPFromDatabase(e,r){try{return await this.getDb().delete(P).where(and(eq(P.identifier,e.email),eq(P.tokenType,r))),Promise.resolve(!0)}catch(s){return i.createErrorResponse(s)}}};var w=class extends te{authenticationService;otpService;emailTemplateService;emailSMTPService;emailService;smtpConfigName="default_smtp";constructor(e,r){super(e,r),this.authenticationService=new _,this.otpService=new de,this.emailTemplateService=new le,this.emailSMTPService=Ge(),this.emailService=new me;}async getSession(){let{user:e}=this.request;return e?this.apiResponse.successResponse("Authorized",e):this.apiResponse.successResponse("No session found")}async register(){let{body:e}=this.request,r=vr.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(a=>a.message).join(" "));await this.authenticationService.duplicateUserCheckByUsername(r.data.username),await this.authenticationService.duplicateUserCheckByEmail(r.data.email);let s={name:r.data.name,username:r.data.username,email:r.data.email,password:r.data.password,emailVerified:null,role:"MEMBER",image:null},o=await this.authenticationService.createUser(s),n=await this.otpService.saveOTPToDatabase(o.data,b.EMAIL_VERIFICATION);if(n&&o.data.email)try{await We({emailTemplateService:this.emailTemplateService,emailService:this.emailService,templateName:"email_verification",emailConfigName:this.smtpConfigName,to:o.data.email,templateData:{username:o.data.username,otp:n,otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)}});}catch(a){console.error("Failed to send verification email:",a);}return process.env.SHOW_OTP?(console.log(`OTP for user ${o.data.username}: ${n}`),this.apiResponse.successResponse("User registered successfully",{otp:n,otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})):this.apiResponse.successResponse("User registered successfully",{otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})}async reRequestOTP(){let{body:e}=this.request,r=Be.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(a=>a.message).join(" "));let s=await this.authenticationService.findUserByEmail(r.data.email);if(s.data.emailVerified)return this.apiResponse.badResponse("User is already verified");let o=await this.otpService.saveOTPToDatabase(s.data,b.EMAIL_VERIFICATION),n=await this.emailTemplateService.retrieveEmailTemplate("email_verification");return o&&s.data.email&&n.data,process.env.SHOW_OTP?(console.log(`OTP for user ${s.data.username}: ${o}`),this.apiResponse.successResponse("OTP sent to your email",{otp:o,otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})):this.apiResponse.successResponse("OTP sent to your email",{otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})}async verifyUser(){let{body:e}=this.request,r=qe.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(o=>o.message).join(" "));let s=await this.authenticationService.findUserByEmail(r.data.email);return await this.otpService.verifyOTPFromDatabase(s.data,String(r.data.otp),b.EMAIL_VERIFICATION),await this.otpService.deleteOTPFromDatabase(s.data,b.EMAIL_VERIFICATION),await this.authenticationService.accountVerification(s.data.id),this.apiResponse.successResponse("User verified successfully")}async verifyIdentity(){let{body:e}=this.request,r=Sr.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(n=>n.message).join(" "));let s=await this.authenticationService.findUserByUsernameOrEmail(r.data.usernameOrEmail);if(await this.authenticationService.passwordChecker(r.data.password,s.data.password),!s.data.emailVerified)return this.apiResponse.badResponse("User is not verified. Please verify your email.");let o=await this.otpService.saveOTPToDatabase(s.data,b.LOGIN_OTP);if(o&&s.data.email)try{We({emailTemplateService:this.emailTemplateService,emailService:this.emailService,templateName:"login_otp",emailConfigName:this.smtpConfigName,to:s.data.email,templateData:{username:s.data.username,otp:o,otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)}});}catch(n){console.error("Failed to send verification email:",n);}return process.env.SHOW_OTP?(console.log(`OTP for user ${s.data.username}: ${o}`),this.apiResponse.successResponse("Identity verified. OTP sent your email",{otp:o,otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})):this.apiResponse.successResponse("Identity verified. OTP sent your email",{otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})}async login(){let{body:e}=this.request,r=Rr.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(a=>a.message).join(" "));let s=await this.authenticationService.findUserByUsernameOrEmail(r.data.usernameOrEmail);if(!s.data.emailVerified)return this.apiResponse.badResponse("User is not verified. Please verify your email.");await this.authenticationService.passwordChecker(r.data.password,s.data.password),await this.otpService.verifyOTPFromDatabase(s.data,String(r.data.otp),b.LOGIN_OTP),await this.otpService.deleteOTPFromDatabase(s.data,b.LOGIN_OTP);let{password:o,...n}=s.data;this.request.login(n,a=>a?this.apiResponse.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Login failed"}):this.apiResponse.successResponse("Login successful",n));}async loginWithGoogle(){let e=null,r=this.request.query.state;if(r)try{e=JSON.parse(Buffer.from(r,"base64").toString()).redirect,e&&typeof e=="string"&&(e=decodeURIComponent(e));}catch(s){console.error("Error decoding state:",s);}return e?this.response.redirect(e):this.apiResponse.successResponse("Google login successful",{user:this.request.user})}async logout(){this.request.session.destroy(e=>e?this.apiResponse.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Error logging out"}):(this.response.clearCookie(process.env.SESSION_COOKIE_NAME),this.apiResponse.successResponse("Logged out")));}async resetPasswordOTPRequest(){let{body:e}=this.request,r=Be.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(a=>a.message).join(" "));let s=await this.authenticationService.findUserByEmail(e.email),o=await this.otpService.saveOTPToDatabase(s.data,b.PASSWORD_RESET),n=await this.emailTemplateService.retrieveEmailTemplate("password_reset");return o&&s.data.email&&n.data,process.env.SHOW_OTP?(console.log(`OTP for user ${s.data.username}: ${o}`),this.apiResponse.successResponse("OTP sent to your email",{otp:o,otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})):this.apiResponse.successResponse("Password reset OTP sent",{otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})}async resetPasswordOTPVerify(){let{body:e}=this.request,r=qe.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(o=>o.message).join(" "));let s=await this.authenticationService.findUserByEmail(r.data.email);return await this.otpService.verifyOTPFromDatabase(s.data,String(r.data.otp),b.PASSWORD_RESET),this.apiResponse.successResponse("OTP verified successfully")}async resetPasswordConfirm(){let{body:e}=this.request,r=Er.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(o=>o.message).join(", "));let s=await this.authenticationService.findUserByEmail(r.data.email);return await this.otpService.verifyOTPFromDatabase(s.data,String(r.data.otp),b.PASSWORD_RESET),await this.otpService.deleteOTPFromDatabase(s.data,b.PASSWORD_RESET),await this.authenticationService.changePassword(s.data.id,r.data.password),this.apiResponse.successResponse("User password reset")}};function jt(t,e,r,s){let o=new C(r);if(zt(t,e),t instanceof ZodError){Bt(t,o);return}if(t.name==="ValidationError"){qt(t,o);return}if(t.name==="CastError"){Vt(t,o);return}if(t.name==="MongoError"||t.name==="MongoServerError"){Kt(t,o);return}if(t.code==="ECONNREFUSED"){Gt(t,o);return}if(t.name==="JsonWebTokenError"){Wt(t,o);return}if(t.name==="TokenExpiredError"){Qt(t,o);return}if(t.name==="SyntaxError"&&t.message.includes("JSON")){Yt(t,o);return}if(t.code==="LIMIT_FILE_SIZE"){Jt(t,o);return}if(t.code==="EBADCSRFTOKEN"){Xt(t,o);return}if(t.status||t.statusCode){Zt(t,o);return}es(t,o);}function Ht(t,e){new C(e).sendResponse({status:StatusCodes.NOT_FOUND,message:`Route ${t.method} ${t.originalUrl} not found`});}function v(t){return (e,r,s)=>{Promise.resolve(t(e,r,s)).catch(s);}}function Pr(t){t.use(Ht),t.use(jt);}function zt(t,e){let r=new Date().toISOString(),s=e.method,o=e.originalUrl,n=e.get("User-Agent")||"Unknown",a=e.ip||e.socket.remoteAddress||"Unknown";console.error(f.red("=".repeat(80))),console.error(f.red(`\u{1F6A8} ERROR OCCURRED AT: ${r}`)),console.error(f.yellow(`\u{1F4DD} REQUEST: ${s} ${o}`)),console.error(f.cyan(`\u{1F310} IP: ${a}`)),console.error(f.cyan(`\u{1F50D} User-Agent: ${n}`)),console.error(f.red(`\u274C ERROR NAME: ${t.name||"Unknown"}`)),console.error(f.red(`\u{1F4AC} ERROR MESSAGE: ${t.message||"No message"}`)),t.stack&&(console.error(f.gray("\u{1F4DA} STACK TRACE:")),console.error(f.gray(t.stack))),console.error(f.red("=".repeat(80)));}function Bt(t,e){let r=t.issues.map(s=>({field:s.path.join("."),message:s.message}));e.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:r}});}function qt(t,e){let r=Object.values(t.issues||{}).map(s=>({field:s.path,message:s.message}));e.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:r}});}function Vt(t,e){e.badResponse(`Invalid ${t.path}: ${t.value}`);}function Kt(t,e){if(t.code===11e3){let r=Object.keys(t.keyValue||{})[0];e.sendResponse({status:StatusCodes.CONFLICT,message:`Duplicate value for field: ${r}`});return}e.internalServerError("Database operation failed");}function Gt(t,e){e.sendResponse({status:StatusCodes.SERVICE_UNAVAILABLE,message:"Database connection failed. Please try again later."});}function Wt(t,e){e.unauthorizedResponse("Invalid authentication token");}function Qt(t,e){e.unauthorizedResponse("Authentication token has expired");}function Yt(t,e){e.badResponse("Invalid JSON format in request body");}function Jt(t,e){e.badResponse("File size exceeds the allowed limit");}function Xt(t,e){e.forbiddenResponse("Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.");}function Zt(t,e){let r=t.status||t.statusCode||StatusCodes.INTERNAL_SERVER_ERROR,s=t.message||"An error occurred";e.sendResponse({status:r,message:s});}function es(t,e){e.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Something went wrong. Please try again later."});}function Nr(){process.on("uncaughtException",t=>{console.error(f.red("\u{1F6A8} UNCAUGHT EXCEPTION:")),console.error(f.red(t.name+": "+t.message)),console.error(f.gray(t.stack)),console.log(f.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("unhandledRejection",(t,e)=>{console.error(f.red("\u{1F6A8} UNHANDLED PROMISE REJECTION:")),console.error(f.red("Reason:"),t),console.error(f.yellow("Promise:"),e),console.log(f.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("SIGTERM",()=>{console.log(f.yellow("\u{1F6D1} SIGTERM received. Starting graceful shutdown...")),process.exit(0);}),process.on("SIGINT",()=>{console.log(f.yellow("\u{1F6D1} SIGINT received. Starting graceful shutdown...")),process.exit(0);});}var rs=process.env.SESSION_COOKIE_NAME,ts=async(t,e,r)=>{let s=new C(e);if(!t.isAuthenticated()){e.clearCookie(rs),s.unauthorizedResponse("Unauthorized: Not authenticated");return}r();},Ur=v(ts);var Dr=(()=>{let t=rr.Router();return t.get("/me",v(async(e,r)=>{await new w(e,r).getSession();})),t.post("/register",v(async(e,r)=>{await new w(e,r).register();})),t.post("/register/otp",v(async(e,r)=>{await new w(e,r).reRequestOTP();})),t.post("/register/verify",v(async(e,r)=>{await new w(e,r).verifyUser();})),t.post("/verify-identity",v(async(e,r)=>{await new w(e,r).verifyIdentity();})),t.post("/login",v(async(e,r)=>{await new w(e,r).login();})),t.post("/reset-password/request",v(async(e,r)=>{await new w(e,r).resetPasswordOTPRequest();})),t.post("/reset-password/verify",v(async(e,r)=>{await new w(e,r).resetPasswordOTPVerify();})),t.post("/reset-password/confirm",v(async(e,r)=>{await new w(e,r).resetPasswordConfirm();})),t.get("/login/google",(e,r,s)=>{let{redirect:o}=e.query,n={redirect:o},a=Buffer.from(JSON.stringify(n)).toString("base64");$e.authenticate("google",{scope:["profile","email"],state:a,prompt:"select_account"})(e,r,s);}),t.get("/google/callback",$e.authenticate("google",{failureRedirect:"/login"}),v(async(e,r)=>{await new w(e,r).loginWithGoogle();})),t.post("/logout",Ur,v(async(e,r)=>{await new w(e,r).logout();})),t})();var fe=class extends x{sortingHelper;authenticationService;constructor(){super(),this.sortingHelper=new z(p),this.authenticationService=new _;}async createUser(e){try{e.email&&await this.authenticationService.duplicateUserCheckByEmail(e.email),e.username&&await this.authenticationService.duplicateUserCheckByUsername(e.username);let r=await this.getDb().insert(p).values(e).returning(),{password:s,...o}=r[0];return i.createResponse(StatusCodes.CREATED,"User created successfully",o)}catch(r){return i.createErrorResponse(r)}}async retrieveUsers(e){try{let r=this.sortingHelper.applySorting(e.sortBy,e.sortOrder),s=e.from?new Date(e.from):void 0,o=e.to?new Date(e.to):void 0;o&&o.setHours(23,59,59,999);let n=[e.search?ilike(p.name,`%${e.search}%`):void 0,e.roleQuery?inArray(p.role,e.roleQuery):void 0,s?gte(p.createdAt,s):void 0,o?lte(p.createdAt,o):void 0].filter(Boolean),a=n.length>0?and(...n):void 0;if(!e.page||!e.limit)return await this.retrieveAllUsers({where:a,sortBy:e.sortBy,sortOrder:e.sortOrder});let h=await this.getDb().select({count:count()}).from(p).where(a).then(H=>H[0].count),{pagination:d,offset:S}=new W(e.page,e.limit,h).createPagination(),ne=await this.getDb().query.users.findMany({columns:{password:!1},where:a,limit:e.limit?e.limit:void 0,offset:e.limit?S:void 0,orderBy:r});return i.createResponse(StatusCodes.OK,"Users retrieved successfully",ne,d)}catch(r){return i.createErrorResponse(r)}}async retrieveAllUsers(e){try{let r=this.sortingHelper.applySorting(e.sortBy,e.sortOrder),s=await this.getDb().query.users.findMany({where:e.where,orderBy:r,columns:{password:!1}});return i.createResponse(StatusCodes.OK,"Users retrieved successfully",s)}catch(r){return i.createErrorResponse(r)}}async deleteUserByIds(e){try{return await this.getDb().delete(p).where(inArray(p.id,e)),i.createResponse(StatusCodes.OK,"Users deleted successfully",!0)}catch(r){return i.createErrorResponse(r)}}async deleteAllUsers(){try{return await this.getDb().delete(p),i.createResponse(StatusCodes.OK,"All users deleted successfully",!0)}catch(e){return i.createErrorResponse(e)}}async exportUsersToCSV(){try{let e=await this.retrieveAllUsers({sortBy:"asc",sortOrder:"createdAt"}),r={delimiter:{field:",",wrap:'"'},prependHeader:!0},s=json2csv(e.data,r);return i.createResponse(StatusCodes.OK,"CSV file generated successfully",s)}catch(e){return i.createErrorResponse(e)}}};var ms=t=>({sortMethodSchema:s=>z$1.string().optional().transform(o=>o&&t.isValidSortMethod(o)?String(o):s?"id":void 0).pipe(z$1.string().optional()),sortBySchema:s=>z$1.string().optional().transform(o=>o&&t.isValidSortDirection(o)?String(o).toLowerCase():s?"desc":void 0).pipe(z$1.string().optional())}),ls=t=>z$1.string().optional().transform(e=>e?isNaN(Number(e))?10:Number(e):t?10:void 0).pipe(z$1.number().optional()),us=z$1.string().optional().transform(t=>t?String(t):void 0);z$1.object({from:z$1.string().optional().refine(t=>!t||/^\d{4}-\d{2}-\d{2}$/.test(t),{message:"Date must be in YYYY-MM-DD format"}).transform(t=>t?new Date(t):void 0),to:z$1.string().optional().refine(t=>!t||/^\d{4}-\d{2}-\d{2}$/.test(t),{message:"Date must be in YYYY-MM-DD format"}).transform(t=>t?new Date(t):void 0)}).refine(t=>t.from&&t.to?t.from<=t.to:true,{message:"Start date cannot be after end date",path:["from"]});var Ye={page:k("Page").optional(),limit:k("Limit").optional(),sortingMethod:c("Sorting Method").optional(),sortBy:c("Sort By").optional(),search:c("Search").optional(),from:c("From Date").optional(),to:c("To Date").optional()},Ir=t=>{let{sortMethodSchema:e,sortBySchema:r}=ms(t);return z$1.preprocess(s=>{let o=s.page?isNaN(s.page)?1:Number(s.page):void 0,n=!!o;return {page:o,limit:ls(n).parse(s.limit),sortingMethod:e(n).parse(s.sortingMethod),sortBy:r(n).parse(s.sortBy),search:us.parse(s.search),from:s.from,to:s.to}},z$1.object(Ye))};var _r=t=>{let e=Ir(t);return z$1.preprocess(r=>({...e.parse(r),roleQuery:r.roleQuery?String(r.roleQuery).split(","):void 0}),z$1.object({...Ye,roleQuery:z$1.array(c("Role Query")).optional()}))},kr=z$1.object({name:c("Name"),email:N,username:we,password:ce,role:re("Role",ye.enumValues),emailVerified:G("Email Verified")}),Mr=z$1.object({ids:z$1.array(k("User ID"))});var Y=class extends te{userService;sortingHelper;constructor(e,r){super(e,r),this.userService=new fe,this.sortingHelper=new z(p);}async index(){try{let{query:e}=this.request,r=_r(this.sortingHelper).safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(o=>o.message).join(", "));let s=await this.userService.retrieveUsers(r.data);return this.apiResponse.sendResponse(s)}catch(e){return this.apiResponse.sendResponse(e)}}async create(){try{let{body:e}=this.request,r=kr.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(n=>n.message).join(", "));let s={...r.data,image:null,emailVerified:r.data.emailVerified?new Date:null},o=await this.userService.createUser(s);return this.apiResponse.sendResponse(o)}catch(e){return this.apiResponse.sendResponse(e)}}async delete(){try{let{body:e}=this.request,r=Mr.safeParse(e);if(!r.success)return this.apiResponse.badResponse(r.error.issues.map(s=>s.message).join(", "));if(r.data.ids.length>0){let s=await this.userService.deleteUserByIds(e.ids);return this.apiResponse.sendResponse(s)}else {let s=await this.userService.deleteAllUsers();return this.apiResponse.sendResponse(s)}}catch(e){return this.apiResponse.sendResponse(e)}}async export(){try{let e=await this.userService.exportUsersToCSV();return this.apiResponse.sendResponse(e)}catch(e){return this.apiResponse.sendResponse(e)}}};var $r=(()=>{let t=rr.Router();return t.route("/").get((e,r)=>{new Y(e,r).index();}).delete((e,r)=>{new Y(e,r).delete();}),t.get("/export",(e,r)=>{new Y(e,r).export();}),t})();var{generateCsrfToken:Lr,validateRequest:$n,doubleCsrfProtection:Fr,invalidCsrfTokenError:Ln}=doubleCsrf({getSecret:()=>process.env.SECRET,getSessionIdentifier:()=>process.env.SECRET,cookieName:"csrf-token",cookieOptions:{maxAge:36e5,sameSite:R.sameSiteCookieConfig().sameSite,secure:R.sameSiteCookieConfig().secure,...R.sameSiteCookieConfig().domain&&{domain:R.sameSiteCookieConfig().domain}},size:32,errorConfig:{message:"Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.",statusCode:403},getCsrfTokenFromRequest:t=>t.headers["x-csrf-token"]});var jr=(()=>{let t=rr.Router();return t.get("",v(async(e,r)=>{let s=Lr(e,r);new C(r).successResponse("CSRF token generated",s);})),t})();var Hr=[{path:"/csrf-token",router:jr},{path:"/auth",router:Dr},{path:"/user",router:$r}];function Je(t,e=""){let r=[];for(let{path:s,router:o}of Hr){let n=`${e}${s}`;t.use(n,o),o.stack.forEach(a=>{a.route&&Object.keys(a.route.methods).forEach(d=>{r.push({method:d.toUpperCase(),path:`${n}${a.route.path}`});});});}}var zr={origin:function(t,e){!t||process.env.ORIGIN_URL.split(",").includes(t)?e(null,true):e(new Error("Not allowed by CORS"));},credentials:true,methods:["GET","POST","PUT","DELETE"],allowedHeaders:["Content-Type","Authorization","x-csrf-token","ngrok-skip-browser-warning"],maxAge:3600};function Xe(t){t.use((e,r,s)=>{let{method:o,url:n}=e,a=Date.now();console.log(`${f.green("\u2713")} ${o} ${n}`),r.on("finish",()=>{let h=Date.now()-a,d=r.statusCode,S;d>=500?S=f.red(d.toString()):d>=400?S=f.yellow(d.toString()):d>=300?S=f.cyan(d.toString()):d>=200?S=f.green(d.toString()):S=f.red("500"),console.log(`${f.green("\u2713")} ${o} ${n} ${S} in ${h}ms`);}),s();});}function Ze(t){let e=ys({windowMs:9e5,max:100,message:"Too many requests, please try again later."});t.use(e);}var he=class extends Store{async get(e,r){try{let s=await q.select().from(O).where(eq(O.sessionId,e)).execute();if(!s||s.length===0)return r(null,null);let o=s[0];return new Date(o.expires)<new Date?(await this.destroy(e),r(null,null)):r(null,JSON.parse(o.sessionCookie))}catch(s){return r(s)}}async set(e,r,s){try{if(!r)return s?.();let o=JSON.stringify(r),n=r.cookie.expires||new Date(Date.now()+6048e5),a=r?.passport?.user||null;await q.insert(O).values({sessionId:e,sessionCookie:o,userId:a,expires:n}).onConflictDoUpdate({target:O.sessionId,set:{sessionCookie:o,userId:a,expires:n}}).returning(),s?.();}catch(o){s?.(o);}}async destroy(e,r){try{await q.delete(O).where(eq(O.sessionId,e)).execute(),r?.();}catch(s){r?.(s);}}async touch(e,r,s){try{let o=r.cookie.expires||new Date(Date.now()+6048e5);await q.update(O).set({expires:o}).where(eq(O.sessionId,e)).execute(),s?.();}catch{s?.();}}};var vs=Rs({name:process.env.SESSION_COOKIE_NAME,secret:process.env.SECRET,saveUninitialized:false,resave:false,store:new he,cookie:{sameSite:R.sameSiteCookieConfig().sameSite,secure:R.sameSiteCookieConfig().secure,maxAge:6048e5,...R.sameSiteCookieConfig().domain&&{domain:R.sameSiteCookieConfig().domain}}}),Br=vs;var Es=(t,e,r)=>{let s=t.secure?"https":"http",o=t.headers.origin||t.headers.referer||"Unknown",n=o!=="Unknown"?new URL(o.toString()).origin:"Unknown",a=t.headers.host?`${s}://${t.headers.host}`:"Unknown";Z.setClientDomain(n),Z.setServerDomain(a),r();},qr=Es;gt.config();var y=rr();y.use(xs());y.use(rr.json());y.use(urlencoded({extended:true}));y.use(rr.urlencoded({extended:true}));y.use(Ts());y.use(ws(zr));Xe(y);Ze(y);y.use(qr);y.set("trust proxy",1);y.use(Br);y.use($e.initialize());y.use($e.session());y.use(Fr);Fe(y);Je(y);Pr(y);var Kr=y;var Ns=z$1.object({SMTP_HOST:c("SMTP_HOST"),SMTP_PORT:Te("SMTP_PORT",{min:1,max:65535,int:true}),SMTP_USER:c("SMTP_USER"),SMTP_PASSWORD:c("SMTP_PASSWORD")}),Us=z$1.object({GOOGLE_CLIENT_ID:c("GOOGLE_CLIENT_ID"),GOOGLE_CLIENT_SECRET:c("GOOGLE_CLIENT_SECRET"),GOOGLE_CALLBACK_URL:c("GOOGLE_CALLBACK_URL")}),As=z$1.object({COOKIE_SETTINGS:re("COOKIE_SETTINGS",["locally","globally"]),COOKIE_DOMAIN:c("COOKIE_DOMAIN"),COOKIE_SAME_SITE:re("COOKIE_SAME_SITE",["lax","strict","none"])}),Ds=z$1.object({DATABASE_URL:c("DATABASE_URL"),PORT:Te("PORT",{min:1,int:true}),SECRET:c("SECRET"),NODE_ENV:re("NODE_ENV",["development","production"]),SESSION_COOKIE_NAME:c("SESSION_COOKIE_NAME"),ORIGIN_URL:c("ORIGIN_URL"),OTP_RESET_EXPIRY:Te("OTP_RESET_EXPIRY",{min:1,int:true}),SHOW_OTP:c("SHOW_OTP").refine(t=>G(t)?true:"SHOW_OTP must be a boolean value (true or false)"),API_URL:c("API_URL"),...As.shape,...Ns.shape,...Us.shape}),Gr=Ds.safeParse(process.env);if(!Gr.success){let t=Gr.error.issues.map(e=>e.message).join(`
`);console.error(f.red(`Environment validation failed:
${t}`)),process.exit(1);}var Cs=()=>{try{let t=join(process.cwd(),"package.json"),e=JSON.parse(readFileSync(t,"utf-8")),r=e.dependencies?.express||e.devDependencies?.express;if(r)return r.replace(/[\^~<>=\s]/g,"");let s=join(process.cwd(),"node_modules/express/package.json");return JSON.parse(readFileSync(s,"utf-8")).version}catch{return "unknown"}},Yr=Cs;var ks=Yr();Nr();var Ms=async()=>{try{let t=process.env.PORT||8080,e=Is.address(),r="production";Kr.listen(t,()=>{console.log(f.magenta(`
\u25B2 Express.js ${ks}`)),console.log(`- Local:        http://localhost:${t}`),console.log(`- Network:      http://${e}:${t}`),console.log(`- Environment:  ${r}`),console.log();});}catch(t){console.error("Failed to start server:",t),process.exit(1);}};Ms();